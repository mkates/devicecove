{% extends 'base.html' %}
{% block headertitle %}<title>VetCove | Cart</title>{% endblock%}
{% block headercss %}
<link href="{{STATIC_URL}}css/cartitem.css" rel="stylesheet" type="text/css" />
<style>

.maincontainer {
	max-width: 1000px;
	margin: 30px auto
}
.maincontainer .cart-header {
	border-bottom: 1px solid #eee;
	margin-bottom: 10px;
}
.maincontainer .cart-header span {
	font-weight: 800;
}
.item-summary {
	padding-left: 0px;
	padding-right: 10px;
}
.maincontainer .cart-header .cart-actions {
	float: right;
	margin-top: 40px;
	margin-right: 20px;
}
.maincontainer .cart-header .cart-actions a {
	padding-left 25px;
	font-size: 13px;
	margin-left: 10px;
}
.welcome-message {
	padding: 10px 0 10px 20px;
	margin: 0;
	font-weight: 400;
}
.maincontainer h3 {
	display: block;
	padding-left: 20px;
	font-weight: 200;
	padding-bottom: 10px;
	margin-top: 0px;
}


/*Sidebar order summary */
.cart-summary {
	padding: 10px 10px 20px 10px;
}
.cart-summary h6 {
	font-size: 15px;
	margin-bottom: 20px;
}
.cart-summary p {
	font-size: 13px;
	margin: 3px 0;
	
}
.cart-summary .total {
	padding-top: 5px;
	border-top:2px solid #eee;
	font-weight: 800;
}
.cart-summary p span {
	float: right;
}
#itemcount {
	float: none;
}

/*If no items */
.noitems {
	min-height: 200px;
	{% if itemcount %}
	display: none;
	{% endif %}
}

</style>
{% endblock%}


{% block content %}
{% load humanize %}
<div class="maincontainer">
	<div class="cart-header covebox">
		<div class="cart-actions">
			<a class="button-small button button-rounded" href="/productsearch/veterinary/all/all">Continue Shopping</a>
			{% if shoppingcart.cartitem_set.all %}
			<a class="button-small button button-rounded button-action proceedtocheckout" href="/checkout/verify">Proceed To Checkout</a>
			{% endif %}
		</div>
		<p class="welcome-message">{% if user.basicuser %}Hi {{user.basicuser.name}},{% else %}Save your cart items for later by <a href="/login">Logging In</a>{% endif %}</p>
		<h3>You have <span class="itemcount">{{itemcount}}</span> item{% if count != 1 %}s{% endif %} in your shopping cart</h3>
	</div>
	<div class="row">
		<div class="item-summary col-md-9 col-sm-9 col-xs-12">
			{% for cartitem in shoppingcart.cartitem_set.all %}
			<div class="covebox cart-item" id="cart-item-{{cartitem.item.id}}">
				<div class="row">
					<div class="item-image col-md-3 col-sm-3 col-xs-12">
						<img src="{%if cartitem.item.mainimage %}{{cartitem.item.mainimage.photo_medium.url}}{% else %}{{STATIC_URL}}img/noimage.jpg{% endif %}" alt="{{cartitem.item.name}}"/>		
					</div>
					<div class="item-information col-md-7 col-sm-7 col-xs-12">
						<h6><a href="/item/{{cartitem.item.id}}/details">{{cartitem.item.name}}</a></h6>
						<p>Sold by: {{cartitem.item.user.company}} ({{cartitem.item.user.city}}, {{cartitem.item.user.state}} {{cartitem.item.user.zipcode}})</p>
						<p class="item-quantity">Quantity: <span class="quantity">
								{% load get_range %}
								{% if cartitem.item.quantity > 1 %}
									<select class="item-quantity" data-itemid='{{cartitem.item.id}}' data-item-handle='#cart-item-{{cartitem.item.id}}'>
									{% for i in cartitem.item.quantity|get_range %}
										{% if i > 0 %}
											<option value="{{i}}" {% if i == cartitem.quantity %}selected{% endif%}>{{i}}</option>
										{% endif %}
									{% endfor %}
									</select>
								{% else %}
									1
								{% endif %}

						</span></p>
						{% if cartitem.numbercarts %}<p class="otherbuyers">{{cartitem.numbercarts}} other {%if cartitem.numbercarts == 1 %}person has{% else %}people have{% endif %} this item in their cart</p>{% endif %}
						<span class="item-actions"><a data-itemid='{{cartitem.item.id}}' data-item-handle='#cart-item-{{cartitem.item.id}}' class="move-to-saved">Move to Saved Items</a> &sdot; <a class="delete-item" data-itemid='{{cartitem.item.id}}' data-item-handle='#cart-item-{{cartitem.item.id}}'>Delete Item</a></span>
					</div>
					<div class="item-price col-md-2 col-sm-2 col-xs-12">
						<p>${{cartitem.item.price|floatformat|intcomma}}</p>
					</div>
				</div>
				<div class="item-loader">
					<img src="{{STATIC_URL}}img/ajax-loader.gif"/>
				</div>
			</div>
			{% endfor %}
			<div class="covebox noitems">
				<p>You do not currently have any items in your cart</p>
			</div>
			
		</div>
		<div class="covebox cart-summary col-md-3 col-sm-3 col-xs-12">
			<h6> Order Summary</h6>
			<p>Items (<span id="itemcount" class="itemcount">{{itemcount}}</span>)<span class="totalprice">{{total}}</span></p>
			<p>Shipping <span>FREE</span></p>
			<p class="total">Total:<span class="totalprice">{{total}}</span></p>
		</div>
		
	</div>
</div>


{% endblock %}

{% block jsblock %}
<script>
$(document).ready(function() {
	imageObj = new Image();
	imageObj.src= "{{STATIC_URL}}img/whitetransparency.png"
	 
	$('.delete-item').click(function() {
		updateCart($(this),'delete','');	
	});
	$('.move-to-saved').click(function() {
		updateCart($(this),'watchlist','');	
	});
	$('.item-quantity').change(function() {
		updateCart($(this),'quantity',$(this).val());	
	});
});

function updateCart(handle,method,quantity) {
	var item_handle = $(handle.attr('data-item-handle'));
	var itemid = $(handle).attr('data-itemid');
	data = {'method':method,'itemid':itemid,'quantity':quantity};
	item_handle.find('.item-loader').css('display','block');
	$.ajax({
		type : "POST",
		data : data,
		url : "/updatecart",
		success : function(data) {
			if ( data['status'] == '400' && method == 'delete' ){
				$(item_handle).remove();
			} else if (data['status'] == '400' && method == 'watchlist'){
				$(item_handle).remove();
			} else if (data['status'] == 600) {
				window.location.href = data['redirect']
			}
			console.log(data['count']);
			item_handle.find('.item-loader').css('display','none');
			$(".totalprice").text(data['total']);
			$(".itemcount").text(data['itemcount']);
			$("#sc-count").text(data['itemcount']);
			if (data['itemcount'] == '0') {
				$('.noitems').css('display','block');
				$('.proceedtocheckout').css('display','none');
			}
		}, 
		error : function(jqXHR, textStatus, errorThrown) {
			alert(textStatus);
		}
	});

}
</script>
{% endblock %}