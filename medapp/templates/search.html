{% extends 'base.html' %}
{% block headercss %}
<link href='{{STATIC_URL}}css/base.css' rel='stylesheet' type='text/css' />
<link href='{{STATIC_URL}}css/productitem.css' rel='stylesheet' type='text/css' />
<link href='{{STATIC_URL}}css/search.css' rel='stylesheet' type='text/css' />
<link href='{{STATIC_URL}}css/jquery-ui-1.10.3.custom.css' rel='stylesheet' type='text/css' />

{% endblock%}


{% block content %}

<div class='row searchcontainer'>
  <!--Filter Container -->
  <div class='col-xs-12 col-sm-3 filtercontainer'>
  	<div id='treeflow' class='filterbox'>
  		<a href='/search' id='toptree'>All Industries</a>
  		<a href='/' id='industrytree'>{{ industry }}</a>
  		{% for cat in category %}
  			<a href='#' id='devicecategorytree'>{{ cat.name }}</a>
  		{% endfor %}
  	</div>
  	<div class='filterbox'>
  		<div class='filter-category'>
  			<h2>Condition</h2>
  			<div class='checkbox'>
				<input id='check1' type='checkbox' name='check' value='check1' checked='checked'>
				<label for='check1'>New</label>
				<input id='check2' type='checkbox' name='check' value='check2' checked='checked'>
				<label for='check2'>Like New</label>
				<input id='check3' type='checkbox' name='check' value='check3' checked='checked'>
				<label for='check3'>Gently Used</label>
				<input id='check4' type='checkbox' name='check' value='check4' checked='checked'>
				<label for='check4'>Average</label>
				<input id='check5' type='checkbox' name='check' value='check5' checked='checked'>
				<label for='check5'>Below Average</label>
				<input id='check6' type='checkbox' name='check' value='check6' checked='checked'>
				<label for='check6'>Good for Parts Only</label>
			</div>
  		</div>
  		<div class='filter-category'>
  			<h2>Features</h2>
  			<div class='checkbox'>
				<input id='check1_1' type='checkbox' name='check' value='check1_1' checked='checked'>
				<label for='check1_1'>New</label>
				<br>
				<input id='check2_1' type='checkbox' name='check' value='check2_1' checked='checked'>
				<label for='check2_1'>3rd Party Refurbished</label>
				<br>
				<input id='check3_1' type='checkbox' name='check' value='check3_1' checked='checked'>
				<label for='check3_1'>Manufacturer Refurbished</label>
			</div>
  		</div>
  		<div id='milecategory' class='filter-category'>
  			<h2>Distance</h2>
  			<select class='form-control'>
  				<option>Any Miles</option>
  				<option>500 Miles</option>
  				<option>250 Miles</option>
  				<option>100 Miles</option>
  				<option>50 Miles</option>
  				<option>25 Miles</option>
  			</select>
  			<p>from</p>
  			<input class='form-control' placeholder='Zipcode' type='number' maxlength='5'/>
  		</div>
  		<div id='pricecategory' class='filter-category'>
  			<h2>Price</h2>
  			<div id='price-slider-container'>
  				<p id='lowprice'>$<span>0</span></p>
  				<p id='highprice'>$<span>20000</span></p>
  				<div class='clear'></div>
  				<div id='price-range' class='light-gradient'></div>
  			</div>
  		</div>
  		
  	</div>
  </div>
  
  <!--Results Container -->
  <div class='col-xs-12 col-sm-9 resultscontainer'>
  	<div id='loadingoverlay'>
  		<div id='loaderdiv'>
  			<h3> Filtering search results . . .</h3>
  			<img src='{{STATIC_URL}}img/ajax-loader2.gif'/>
  		</div>
  	</div>
  	<div class='resultsbox resultsnav'>
  		<div class='' id='resultsparameter'>
  		Searching for {{ search }}
  		</div>
  		<div id='sortby'>
  			<p> Sort By: </p>
  			<select class='form-control'>
  				<option> Relevance </option>
  				<option> Price </option>
  				<option> Best Deal </option>
  				<option> Most Viewed</option>
  				<option> Newest</option>
  			</select>
  		</div>
  		<div id='numberofresults'>2038 Results</div>
  		<img class='viewtypeimg' src='{{STATIC_URL}}img/listview.png'/>
  		<p> List View </p>
  		<img class='viewtypeimg' src='{{STATIC_URL}}img/gridview.png'/>
  		<p> Grid View </p>
  		<div class='clear'></div>
  	</div>
  	
  	<div class='resultsbox' id='resultsbody'>
  		{%for product in products %}
  		<div class='resultitem'>
  			<div class='imageviewer'></div>
  			<div class='imgdiv'><img src='{{product.mainimage}}'/></div>
  			<div class='pricediv'>
  				<h6>pre-owned from</h6>
  				<p>$14,300</p>
  				<a class='btn btn-standard' href="/product/{{product.id}}/details">Select</a>
  			</div>
  			<div class='textdiv'>
  				<h2>{{ product.name }}</h2>
  				<h3> {{product.manufacturer }}</h3>
  				<h4><a>New (2) <span>$27,480</span></a></h4>
  				<h4><a>Refurbished (1) <span>$20,120</span></a></h4>
  				<h4><a>Preowned (4) <span>$14,300</span></a></h4>
  				<div class='buttondiv'>
  					<button class='infobutton'>Details</button>
  					<button class='infobutton'>Specs</button>
  					<button class='infobutton'>Buyer Protection</button>
  				</div>
  			</div>
  			<div class='clear'></div>
  			<div class='detailsdiv hidden'>
  				<div class='detailtext'>
  					<p>{{product.description}}</p>
  				</div>
  				<div class='imagegallery'>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  					<div class='imagethumbnail'></div>
  				</div>
  				<div class='morediv'>
  					<a href="/product/{{product.id}}/details"> Show all product details &#8594;</a>
  					<button class='closebutton'>Close</button>
  				</div>
  			</div>
  			<div class='clear'></div>

  		</div>
  		{% endfor %}
  	</div>
  	<div id='showmorebutton' class='resultsbox'>
  		<p>Show More Results</p>
  		<img src='..{{STATIC_URL}}img/ajax-loader.gif'/>
  	</div>
  </div>
  	
</div>
{% endblock %}

{% block jsblock %}
<script src='{{STATIC_URL}}js/jquery-ui-1.10.3.custom.min.js' type='text/javascript' ></script>
<script>
//*********************************************
//Global variable dictionary ******************
//*********************************************
var variables = {'querytype':'product','query':'ultrasound','industry':'veterinary','sortby':'relevance','pricelow':0,'pricehigh':100000,'new':true,'refurbished':true,'used':true};

//*********************************************
//*** Miscellaneous Page Functions ************
//*********************************************
$(document).ready(function(){
	activateResultsBoxItems();
	//When the show more button is pressed, load in more products
	$('#showmorebutton').click(function() {
		$('#showmorebutton p').css('display','none');
		$('#showmorebutton img').css('display','block');
		$.ajax({
			url: '/searchquery',
			type: 'GET',
			data: variables,
			cache: false,
			dataType: 'json',
			success: function(response){
				$.each(response, function( key, pd) {
					generateProduct(pd['name'],pd['manufacturer'],pd['description'],pd['lowprice']);
					console.log("Generating more products");
				});
				$('#showmorebutton p').css('display','block');
				$('#showmorebutton img').css('display','none');
			}
		});
	});
	
	//The price filter functionality when it is toggled
	$(function() {
		$( '#price-range' ).slider({
			range: true,
			min: 0,
			max: 20000,
			step: 200,
			values: [ 0, 20000 ],
			slide: function( event, ui ) {
				$( '#amount' ).val( '$' + ui.values[ 0 ] + ' - $' + ui.values[ 1 ] );
				var newhighvalue = ui.values[1].toString();
				var newlowvalue = ui.values[0].toString();
				if (newlowvalue.length > 3 ) {
					var newlowvalue = newlowvalue.splice( newlowvalue.length-3, 0, ',' );
				} 
				if (newhighvalue.length > 3) {
					var newhighvalue = newhighvalue.splice( newhighvalue.length-3, 0, ',' );
				}
				$('#lowprice span').html(newlowvalue);
				$('#highprice span').html(newhighvalue);
			}
			});
			$( '#amount' ).val( '$' + $( '#slider-range' ).slider( 'values', 0 ) +
			' - $' + $( '#slider-range' ).slider( 'values', 1 ) );
		});
	});

//Functionality for the show more buttons
var togglebuttons = function togglebutton(handler) {
	var buttons = handler.parent().children();
		if (!(handler.hasClass('activeinfo'))) {
			for (var b=0; b < buttons.length; b++) {
				$(buttons[b]).removeClass('activeinfo');
				handler.addClass('activeinfo');
			}
			handler.parent().parent().parent().children('div.detailsdiv').removeClass('hidden');
		}
}

//Update function when a filter is called
var update = function loading() {
	$('#loadingoverlay').css('display','block');
	$.ajax({
		url: '/searchquery',
		type: 'GET',
		data: variables,
		cache:false,
		dataType: 'json',
		success: function(response){
			console.log(response)
			$('#showmorebutton p').css('display','block');
			$('#showmorebutton img').css('display','none');
		}
	});
	$('#loadingoverlay').css('display','none');
}

//*********************************************
//*** Product Box Generator *******************
//*********************************************

var generateProduct = function(name,manufacturer,description,lowprice) {
	productString="<div class='resultitem'> \
  			<div class='imageviewer'></div> \
  			<div class='imgdiv'><img src='http://www.sivanienterprises.com/images/papercup_SE930.jpg'/></div> \
  			<div class='pricediv'> \
  				<h6>pre-owned from</h6> \
  				<p>"+lowprice+"</p> \
  				<a class='btn btn-standard' href='#'>Select</a> \
  			</div> \
  			<div class='textdiv'> \
  				<h2>"+name+"</h2> \
  				<h3>"+manufacturer+" | 2006 Model</h3> \
  				<h4><a>New (2) <span>$27,480</span></a></h4> \
  				<h4><a>Refurbished (1) <span>$20,120</span></a></h4> \
  				<h4><a>Preowned (4) <span>$14,300</span></a></h4> \
  				<div class='buttondiv'> \
  					<button class='infobutton'>Details</button> \
  					<button class='infobutton'>Specs</button> \
  					<button class='infobutton'>Buyer Protection</button> \
  				</div> \
  			</div> \
  			<div class='clear'></div> \
  			<div class='detailsdiv hidden'> \
  				<div class='detailtext'> \
  					<p>"+description+"</p> \
  				</div> \
  				<div class='imagegallery'> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  					<div class='imagethumbnail'></div> \
  				</div> \
  				<div class='morediv'> \
  					<a> Show all product details &#8594;</a> \
  					<button class='closebutton'>Close</button> \
  				</div> \
  			</div> \
  			<div class='clear'></div> \
  		</div>";
  					
  	$("#resultsbody").append(productString);
  	activateResultsBoxItems();
}

// We must rebind all the actions when results are added to the page
var activateResultsBoxItems = function activateResultsBoxItems() {	
	//When user clicks for more information
	$('.infobutton').click(function() {
		togglebuttons($(this));
	});
	
	//When user closes the more information
	$('.closebutton').click(function() {
		$(this).parent().parent().addClass('hidden');
		var buttons = $(this).parent().parent().parent().children('div.textdiv').children('div.buttondiv').children();
		for (var b=0; b < buttons.length; b++) {
				$(buttons[b]).removeClass('activeinfo');
			}
	});
	//When a user clicks on an image
	$('.imgdiv img').click(function() {
		togglebuttons($($(this).parent().parent().children('div.textdiv').children('div.buttondiv').children()[0]));
	});
	
	//When a user hovers over a thumbnail
	$('.imagethumbnail').hover(function() {
		$(this).parent().parent().parent().children('div.imageviewer').css('display','block');
	}, function() {
		$(this).parent().parent().parent().children('div.imageviewer').css('display','none');
	});
};


//*********************************************
//*** Helper Functions ************************
//*********************************************

//Used by the slider to convert a number back to an integer
String.prototype.splice = function( idx, rem, s ) {
    return (this.slice(0,idx) + s + this.slice(idx + Math.abs(rem)));
};
</script>
{% endblock %}