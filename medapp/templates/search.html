{% extends 'base.html' %}
{% block headercss %}
<link href='{{STATIC_URL}}css/base.css' rel='stylesheet' type='text/css' />
<link href='{{STATIC_URL}}css/productitem.css' rel='stylesheet' type='text/css' />
<link href='{{STATIC_URL}}css/jquery-ui-1.10.3.custom.css' rel='stylesheet' type='text/css' />
<link href='{{STATIC_URL}}css/search.css' rel='stylesheet' type='text/css' />

<style>
.catlink {
	display: block;
	padding-left: 3px;
	padding-right: 5px;
	font-size: 13px;
}
label .floatright {
	float: right;
}
.catlink:hover {
	background: #eee;
	text-decoration: none;
}
.noresults {
	opacity: .9;
	max-width: 230px;
}
#noresults {
	text-align: center;
	margin: 10px auto;
	padding: 30px 40px;
	{% if items %}
	display: none;
	{% endif %}
}
#noresults p {
	font-size: 14px;
	font-weight: 200;
}
#noresults .noluck {
	font-size: 23px;
	font-weight: 200;
	padding-bottom: 15px;
}
/***If more than 10 items, display the showmore button**/
{% if more %}
.showmorebutton {
	display: block;
}
{% endif %}
.cat-hidden {
	display:none;
}
.seeall {
	display:none;
	color: #2BB4EF;
	font-size: 13px;
	padding-left: 3px;
	margin: 0;
}
.seeall:hover {
	text-decoration: underline;
	color: #27A5DB;
	cursor: pointer;
}
.nobottomborder {
	border-bottom: none;
}
</style>
{% endblock%}

{% block content %}
{% load humanize %}
<div class='row searchcontainer'>
  <!--Filter Container -->
  <div class='col-xs-12 col-sm-3 filtercontainer'>
  	<div class='filterbox'>
  		<h4>Categories</h4>
  		<div class='filter-category notopborder'>
			<h2>{{ind | title}}</h2>
			{% for cat in categories %} 
				{% if cat.totalunits > -1 %}
					{% if forloop.counter < 7 %} 			
						{% if category.name != cat.name %}<a class="catlink" href="/productsearch/{{ind.name}}/{{cat.name}}/all">{{cat.displayname}} <span>{{cat.totalunits}}</span></a>{% endif %}
					{% else %}
						<div class="{% if custom == on %}cat-hidden{% endif %}">
							{% if category.name != cat.name %}<a class="catlink" href="/productsearch/{{ind.name}}/{{cat.name}}/all">{{cat.displayname}} <span>{{cat.totalunits}}</span></a>{% endif %}
						</div>
					{% endif %}	
				{% endif %}
			{% endfor %}
			<p class="seeall">Show All Categories</p>
		</div>
		{% if custom == on %}
  		<div class='filter-category nobottomborder'>
			<h2>{{category.displayname}}</h2>
			<a class="catlink {% if subcategory == all %}active{% endif %}" href="/productsearch/{{ind.name}}/{{category.name}}/all">All {{category.displayname}}<span>{{category.totalunits}}</span></a>
			{% for sc in category.subcategory_set.all %} 	
				<a class="catlink {% if subcategory.name == sc.name %}active{% endif %}" href="/productsearch/{{ind.name}}/{{category.name}}/{{sc.name}}">{{sc.displayname}} <span>{{sc.totalunits}}</span></a>
			{% endfor %}
		</div>
		{% endif %}
	</div>
	<div class='filterbox'>
		<h4>Filters</h4>
		<div id='pricecategory' class='filter-category notopborder'>
  			<h2>Price Range</h2>
  			<div id='price-slider-container'>
  				<p id='lowprice'>$<span>{{pricerange.0}}</span></p>
  				<p id='highprice'>$<span>{{pricerange.1}}</span></p>
  				<div class='clear'></div>
  				<div id='price-range' class='light-gradient'></div>
  			</div>
  		</div>
  		<div class='filter-category'>
  			<h2>Condition</h2>
  			<div class='checkbox'>
				<input class="checkboxitem" id='new' type='checkbox' name='check' value='new' checked='checked'>
				<label for='new'>New</label>
				<input class="checkboxitem" id='refurbished' type='checkbox' name='check' value='refurbished' checked='checked'>
				<label for='refurbished'>Refurbished</label>
				<input class="checkboxitem" id='preowned' type='checkbox' name='check' value='preowned' checked='checked'>
				<label for='preowned'>Pre-Owned</label>
			</div>
  		</div>
  		<!-- 
<div class='filter-category'>
  			<h2>Manufacturers</h2>
  			<div class='checkbox'>
				{% for man in manufacturer %}
					<input id='{{man.name}}' type='checkbox' name='check' value='check1_1' checked='checked'>
					<label for='{{man.name}}'>{{man.name}}</label>
				{% endfor %}
			</div>
  		</div>
  		
 -->
  		<div id='milecategory' class='filter-category'>
  			<h2>Distance</h2>
  			<select class='form-control' id="distance-select">
  				<option value="-1">Any Miles</option>
  				<option value="500">500 Miles</option>
  				<option value="250">250 Miles</option>
  				<option value="100">100 Miles</option>
  				<option value="50">50 Miles</option>
  				<option value="25">25 Miles</option>
  			</select>
  			<p>from</p>
  			<input id="zipcode-input" onkeyup="this.value=this.value.replace(/[^\d]/,'')" class='form-control' placeholder='Zipcode' type='number' maxlength='5' value="{{zipcode}}"/>
  		</div>		
  	</div>
  </div>
  
  <!--Results Container -->
  <div class='col-xs-12 col-sm-9 resultscontainer'>
  	<div id='loadingoverlay'>
  		<div id='loaderdiv'>
  			<h3> Filtering search results . . .</h3>
  			<img src='{{STATIC_URL}}img/ajax-loader2.gif'/>
  		</div>
  	</div>
  	<div class='resultsbox resultsnav'>
  		<!-- 
<div class='' id='resultsparameter'>
  		Searching for {{ searchquery }}
  		</div>
 -->
  		<div id='sortby'>
  			<p> Sort By: </p>
  			<select id="sortby-select" class='form-control'>
  				<option value="price"> Price </option>
  				<option value="distance">Distance</option>
  				<option value="mostrecent">Most Recent</option>
  				<option value="leastrecent">Least Recent</option>
  			</select>
  		</div>
  		<div id='numberofresults'>{{ resultcount }} Results</div>
  		<p>Searching for {{ searchquery }}</p>
  		<!-- 
<img class='viewtypeimg' src='{{STATIC_URL}}img/listview.png'/>
  		<p> View By Product </p>
  		<img class='viewtypeimg' src='{{STATIC_URL}}img/gridview.png'/>
  		<p> View By Seller </p>
 -->
  		<div class='clear'></div>
  	</div>
  	
  	<div class='resultsbox' id='resultsbody'>
  		{% include 'productsearchitem.html' %}
		<div id="noresults" class="resultitem">
			<p class="noluck">Sorry, we can't find anything that matches your search</p>
			<img class="noresults" src="{{STATIC_URL}}img/saddog.jpg"/>
			<p>Try changing your filters, or call us with what you want and we will let you know when one becomes available!</p>
		</div>
		<div class='showmorebutton resultsbox'>
			<p>Show More Results</p>
			<img src='{{STATIC_URL}}img/ajax-loader.gif'/>
		</div>
  	</div>
  </div>
  	
</div>
{% endblock %}

{% block jsblock %}
<script src='{{STATIC_URL}}js/jquery-ui-1.10.3.custom.min.js' type='text/javascript' ></script>
<script src='{{STATIC_URL}}js/searchbox.js' type='text/javascript' ></script>

<script>
//*********************************************
//Global variable dictionary ******************
//*********************************************
var variables = {'sort':'','query':'{{searchquery}}','zipcode':'{{zipcode}}','distance':-1,'page':0,'subcategory':'{{subcategoryname}}','category':'{{categoryname}}','sortby':'price','pricelow':0,'pricehigh':10000000,'new':true,'refurbished':true,'preowned':true};

//*********************************************
//*** Miscellaneous Page Functions ************
//*********************************************
$(document).ready(function(){
	//Show More View
	if ($(".cat-hidden")) {
		$(".seeall").css("display","block");
	}
	$(".seeall").click(function() {
		if ($(this).text() == 'Hide More') {
			$(".cat-hidden").css('display','none');
			$(this).text("Show All Categories");
		} else {
			$(".cat-hidden").fadeIn();
			$(this).text("Hide More");
		}
	});
	//This code calls an API that updates the zip if user is not logged in
	if (variables['zipcode'].length != 5) {
		// $.get("http://ipinfo.io", function(response) {
// 			variables['zipcode'] = response.postal;
// 			$('#zipcode-input').val(response.postal);
// 		}, "jsonp");
	}
	$("#sortby-select").val("price");
	$("#distance-select").val(-1);
	activateResultsBoxItems();
	$('.checkbox').prop('checked', true);
	$(".checkbox").change(function() {
		var checkboxname = $(this).attr('id');
		variables[checkboxname] = ($(this).is(":checked")) ? true: false;
		variables['page'] = 0;
		update();
	});
	$('#distance-select').change(function() {
		variables['distance'] = $(this).val();	
		update();
	});
	$('#zipcode-input').blur(function() {
		if ($(this).val().length == 5) {
			variables['zipcode'] = $(this).val();
			update();
		} else {
			$(this).val("");
		}
	});
	$('#sortby-select').change(function() {
		variables['sort'] = $(this).val();
		variables['page'] = 0;
		update();
	});
	$('.showmorebutton').click(function() {
		$('.showmorebutton p').css('display','none');
		$('.showmorebutton img').css('display','block');
		variables['page'] = variables['page']+1;
		update();
	});
	//The price filter functionality when it is toggled
	$(function() {
		$( '#price-range' ).slider({
			range: true,
			min: {{pricerange.0}},
			max: {{pricerange.1}},
			step: 100,
			values: [{{pricerange.0}},{{pricerange.1}}],
			slide: function( event, ui ) {
				$( '#amount' ).val( '$' + ui.values[ 0 ] + ' - $' + ui.values[ 1 ] );
				var newhighvalue = ui.values[1].toString();
				var newlowvalue = ui.values[0].toString();
				if (newlowvalue.length > 3 ) {
					var newlowvalue = newlowvalue.splice( newlowvalue.length-3, 0, ',' );
				} 
				if (newhighvalue.length > 3) {
					var newhighvalue = newhighvalue.splice( newhighvalue.length-3, 0, ',' );
				}
				$('#lowprice span').html(newlowvalue);
				$('#highprice span').html(newhighvalue);
			},
			stop: function(event,ui ) {
				variables['pricelow'] = ui.values[ 0 ];
				variables['pricehigh'] = ui.values[ 1 ];
				variables['page'] = 0;
				update();
			}
			});
			$( '#amount' ).val( '$' + $( '#slider-range' ).slider( 'values', 0 ) +
			' - $' + $( '#slider-range' ).slider( 'values', 1 ) );
		});
	});

//Update function when a filter is called
var update = function loading() {
	if (variables['page'] == 0) {
		$('#loadingoverlay').css('display','block');
	}
	$.ajax({
		url: '/searchquery',
		type: 'GET',
		data: variables,
		cache: false,
		dataType: 'json',
		success: function(response){
			$('#loadingoverlay').css('display','none');
			$('.showmorebutton p').css('display','block');
			$('.showmorebutton img').css('display','none');
			//If a new search, empty results
			if (variables['page'] == 0) {
				$("#resultcontainer").empty();
			}
			$("#resultcontainer").append(response['result']);
			if ($('.resultitem').length <= 1) {
				$("#noresults").css('display','block');
			} else {
				$("#noresults").css('display','none');
			}
			if (response['more'] == true) {
				$('.showmorebutton').css('display','block');
			} else {
				$('.showmorebutton').css('display','none');
			}
			$("#numberofresults").html(response['resultscount']+" Results");
			activateResultsBoxItems();
		}
	});
}


//*********************************************
//*** Helper Functions ************************
//*********************************************

//Used by the slider to convert a number back to an integer
String.prototype.splice = function( idx, rem, s ) {
    return (this.slice(0,idx) + s + this.slice(idx + Math.abs(rem)));
};
//*********************************************
//*** Unused Functions ************************
//*********************************************

</script>
{% endblock %}